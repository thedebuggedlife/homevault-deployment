version: '3'

secrets:
  restic_password:
    file: ${APPDATA_LOCATION:-/srv/appdata}/backup/restic_password

services:
  homevault-backup:
    image: ghcr.io/thedebuggedlife/homevault-backup:0.1
    container_name: homevault_backup
    restart: unless-stopped
    privileged: true  # Required for LVM access
    secrets:
      - restic_password
    volumes:
      - ${APPDATA_LOCATION:-/srv/appdata}:/data:ro
      # Required for LVM access
      - /dev:/dev:rw
      - /run:/run:rw
      - /etc/lvm:/etc/lvm:ro
      # For Docker container operations
      - /var/run/docker.sock:/var/run/docker.sock
      # Custom hooks (optional)
      - ${APPDATA_LOCATION:-/srv/appdata}/backup/hooks:/hooks:ro
      # Cache volume for better restic performance
      - restic-cache:/root/.cache/restic
    env_file: ${APPDATA_LOCATION:-/srv/appdata}/backup/restic.env
    environment:
      - TZ
      - CRON_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}
      - RESTIC_PASSWORD_FILE=/run/secrets/restic_password
      - BACKUP_PATHS=/data
      - RESTIC_OPTS=--verbose
      - ENABLE_FORGET=${BACKUP_ENABLE_FORGET:-true}
      # Format: [#h][#d][#w][#m][#y]
      # Default: Keep 7 daily, 4 weekly, 6 monthly, 1 yearly
      - RETENTION_POLICY=${BACKUP_RETENTION_POLICY:-7d4w6m1y}
      # LVM Snapshot configuration
      - USE_LVM_SNAPSHOT=false              # Set to true to enable LVM snapshots
      - LVM_VOLUME_GROUP=vg0                # Your volume group name
      - LVM_LOGICAL_VOLUME=data             # Your logical volume name
      - LVM_SNAPSHOT_SIZE=2G                # Size of the snapshot
      - LVM_SNAPSHOT_NAME=restic_snapshot   # Name for the snapshot
      - LVM_MOUNT_PATH=/mnt/snapshot        # Where to mount the snapshot
      - REPLACE_BACKUP_PATH=true            # Replace backup path with snapshot path
      # Docker operations
      - USE_DOCKER=true
      - DOCKER_COMPOSE_PROJECT=homevault
      - DOCKER_COMPOSE_SERVICES=${BACKUP_STOP_SERVICES}

volumes:
  restic-cache: